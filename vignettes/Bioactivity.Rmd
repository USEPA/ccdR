---
title: "Bioactivity APIs"
author: "Center for Computational Toxicology and Exposure"
output:
   prettydoc::html_pretty:
    theme: architect
    toc: yes
    toc_depth: 5
vignette: >
  %\VignetteIndexEntry{Bioactivity}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{css, echo=FALSE}
.scroll-100 {
  max-height: 100px;
  overflow-y: auto;
}

.noticebox {
  padding: 1em;
  background: lightgray;
  color: blue;
  border: 2px solid black;
  border-radius: 10px;
}
```

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(httptest)
start_vignette("6")
```

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
if (!library(ccdR, logical.return = TRUE)){
  devtools::load_all()
}
```

```{r setup-print, echo = FALSE}
# Redefining the knit_print method to truncate character values to 25 characters
# in each column and to truncate the columns in the print call to prevent 
# wrapping tables with several columns.
#library(ccdR)
knit_print.data.table = function(x, ...) {
  y <- data.table::copy(x)
  y <- y[, lapply(.SD, function(t){
    if (is.character(t)){
      t <- strtrim(t, 25)
    }
    return(t)
  })]
  print(y, trunc.cols = TRUE)
}

registerS3method(
  "knit_print", "data.table", knit_print.data.table,
  envir = asNamespace("knitr")
)

# Remove this once Bioactivity goes public
stg_bioactivity_server <- 'https://api-ccte-stg.epa.gov/bioactivity/data'
```

## Introduction

In this vignette, [CCTE Bioactivity APIs](https://api-ccte.epa.gov/docs/bioactivity.html) will be explored. 

::: {.noticebox data-latex=""}

**NOTE:** Please see the introductory vignette for an overview of the *ccdR* package and initial set up instruction with API key storage.

:::

Data for the Bioactivity APIs comes from ToxCast's invitrodb. 

US EPA's Toxicity Forecaster (ToxCast) program makes *in vitro* medium- and high-throughput screening assay data publicly available for prioritization and hazard characterization of thousands of chemicals.

The ToxCast pipeline ([tcpl](https://cran.r-project.org/web/packages/tcpl/index.html)) is an R package that manages, curve-fits, plots, and stores ToxCast data to populate its linked MySQL database, InvitroDB. These assays comprise Tier 2-3 of the new Computational Toxicology Blueprint, and employ automated chemical screening technologies, to evaluate the effects of chemical exposure on living cells and biological macromolecules, such as proteins (Thomas et al., 2019). More information on the ToxCast program can be found at <https://www.epa.gov/chemical-research/toxicity-forecasting>.

This flexible analysis pipeline is capable of efficiently processing and storing large volumes of data. The diverse data, received in heterogeneous formats from numerous vendors, are transformed to a standard computable format and loaded into the <font face="CMTT10"> tcpl </font> database by vendor-specific R scripts. Once data is loaded into the database, ToxCast utilizes generalized processing functions provided in this package to process, normalize, model, qualify, and visualize the data.

<center>

![<font style="font-size:15px"><i>Figure 1: Conceptual overview of the ToxCast Pipeline functionality</i></font>](Pictures/Fig1_tcpl_overview.png)

</center>

## Functions

Several ccdR functions are used to access the CCTE API Bioactivity data.

### Get all assay annotations

`get_all_assays()` retrieves all annotations for all assays available. Optionally, the user can unnest "citation", "gene", "assayList" wider so each element has its own column.

```{r ccdR all assays, message=FALSE, eval=FALSE}
res_dt <- get_all_assays(API_key = apikey, Server = url)
# optionally perform the following unnest, apply names_repair = "unique" to give a unique column name
# note - the gene column may be an array of multiple genes rather than just one, meaning this step may not work
#res_dt <- res_dt |> tidyr::unnest_wider(col = c("citation", "gene", "assayList"), names_repair = "unique")
```

```{r, echo=FALSE, eval=FALSE}
printFormattedTable(head(res_dt), c(4, 18, 19, 33, 51)) # printed using custom formatted table
```

### Get annotation by aeid

`get_annotation_by_aeid()` retrieves annotation for a specific assay endpoint id (aeid).

```{r ccdR annotation by aeid, message=FALSE, eval=FALSE}
res_dt <- get_annotation_by_aeid(AEID = "891", API_key = apikey, Server = url)
# optionally perform this unnest, apply names_repair = "unique" to give a unique column name
# note - the gene column may be an array of multiple genes rather than just one, meaning this step may not work
#res_dt <- res_dt |> tidyr::unnest_wider(col = c("citation", "gene", "assayList"), names_repair = "unique")
```

```{r, echo=FALSE, eval=FALSE}
printFormattedTable(head(res_dt), c(4, 18, 33, 51)) # printed using custom formatted table
```

### Get summary data

`get_bioactivity_summary()` retrieves a summary of the number of active hits compared to the total number tested for both multiple and single concentration by aeid.

```{r ccdR summary by aeid, message=FALSE, eval=FALSE}
res_dt <- get_bioactivity_summary(AEID = "891", API_key = apikey, Server = url)
```

```{r, echo=FALSE, eval=FALSE}
printFormattedTable(head(res_dt), c()) # printed using custom formatted table
```

### Get data

`get_bioactivity_details()` can retrieve all available multiple concentration data by assay endpoint id (aeid), sample id (spid), Level 4 ID (m4id), or chemical DTXSID. Examples for each are provided below:

#### By aeid

```{r ccdR data by aeid, message=FALSE, results = FALSE, eval=FALSE}
res_dt <- get_bioactivity_details(AEID = "891", API_key = apikey, Server = paste0(url, "/data"))
```

```{r, echo=FALSE, eval=FALSE}
printFormattedTable(res_dt[205:210,], c(ncol(res_dt)-2)) # printed using custom formatted table
```

#### By spid

```{r ccdR data by spid, message=FALSE, results = FALSE, eval=FALSE}
res_dt <- get_bioactivity_details(SPID = "TP0001055F12", API_key = apikey, Server = paste0(url, "/data"))
```

```{r, echo=FALSE, eval=FALSE}
printFormattedTable(head(res_dt), c(ncol(res_dt)-2)) # printed using custom formatted table
```

#### By m4id

```{r ccdR data by m4id, message=FALSE, results = FALSE, eval=FALSE}
res_dt <- get_bioactivity_details(m4id = 739695, API_key = apikey, Server = paste0(url, "/data"))
```

```{r, echo=FALSE, eval=FALSE}
printFormattedTable(head(res_dt), c(ncol(res_dt)-2)) # printed using custom formatted table
```

#### By DTXSID

```{r ccdR data by dtxsid, message=FALSE, results = FALSE, eval=FALSE}
res_dt <- get_bioactivity_details(DTXSID = "DTXSID7020182", API_key = apikey, Server = paste0(url, "/data"))
```

```{r, echo=FALSE, eval=FALSE}
printFormattedTable(head(res_dt), c(ncol(res_dt)-2)) # printed using custom formatted table
```

## Example Use Case: Comparing Bioactivity Data Across Chemical Lists

The fourth Drinking Water Contaminant Candidate List (CCL4) is a set of chemicals that "...are not subject to any proposed or promulgated national primary drinking water regulations, but are known or anticipated to occur in public water systems...." Moreover, this list "...was announced on November 17, 2016. The CCL 4 includes 97 chemicals or chemical groups and 12 microbial contaminants...." The National-Scale Air Toxics Assessments (NATA) is "... EPA's ongoing comprehensive evaluation of air toxics in the United States... a state-of-the-science screening tool for State/Local/Tribal agencies to prioritize pollutants, emission sources and locations of interest for further study in order to gain a better understanding of risks... use general information about sources to develop estimates of risks which are more likely to overestimate impacts than underestimate them...."  

These lists can be found in the CCD at [CCL4](https://comptox.epa.gov/dashboard/chemical-lists/CCL4) with additional information at [CCL4 information](https://www.epa.gov/ccl/contaminant-candidate-list-4-ccl-4-0) and [NATADB](https://comptox.epa.gov/dashboard/chemical-lists/NATADB) with additional information at [NATA information](https://www.epa.gov/national-air-toxics-assessment). The quotes from the previous paragraph were excerpted from list detail descriptions found using the CCD links.

In this example use case, bioactivity data will be compared between a water contaminant priority and an air toxics list.  

### Obtain Lists of Chemicals

First, confirm the chemical list to query. 

```{r}
options(width = 100)
ccl4_information <- get_public_chemical_list_by_name('CCL4')
print(ccl4_information, trunc.cols = TRUE)

natadb_information <- get_public_chemical_list_by_name('NATADB')
print(natadb_information, trunc.cols = TRUE)
```
Next, retrieve the list of chemicals associated with each list.

```{r}
ccl4 <- get_chemicals_in_list('ccl4')
ccl4 <- data.table::as.data.table(ccl4)

natadb <- get_chemicals_in_list('NATADB')
natadb <- data.table::as.data.table(natadb)
```

### Review Bioactivity Data for a Single Chemical

ToxCast data is made accessible via the CompTox Chemicals Dashboard (CCD). After navigating to a chemical of interest, select Bioactivity > ToxCast Summary to explore available ToxCast data. The ToxCast bioactivity module presents a view of potency and relative efficacy metrics across ToxCast endpoints for chemicals of interest, such as shown for BPA below. 

<center>

![<font style="font-size:15px"><i>Figure 2: BPA ToxCast Summary Plot</i></font>](./Pictures/CCD_BPA_Bioactivity_ToxCast_TOP.png)
![<font style="font-size:15px"><i>Figure 3: BPA ToxCast Summary Grid</i></font>](./Pictures/CCD_BPA_Bioactivity_ToxCast_BOTTOM.png)
</center>

The ToxCast bioactivity module includes a summary plot, enabling visual response comparisons across assay endpoints, and a summary grid for exporting all available data for a chemical of interest.

CCTE APIs can streamline the process of retrieving this information in a programmatic fashion. Before continuing the analysis of the two chemical lists CCL4 and NATADB, assessing bioactivity data associated with a single chemical (Bisphenol A) via web interface and *ccdR* functions is shown below. 

<center>

![<font style="font-size:15px"><i>Figure 4: CCTE Bioactivity API Web Interface</i></font>](./Pictures/Bioactivity_data_resource.png)

</center>

First, retrieve all available multiple concentration data for Bisphenol A by DTXSID:

```{r}
bpa_bioactivity <- get_bioactivity_details(DTXSID = 'DTXSID7020182', Server = stg_bioactivity_server)
bpa_bioactivity <- data.table::as.data.table(bpa_bioactivity)

head(bpa_bioactivity)
```

Next, it may be helpful to examine the dimensions and column names of output.

```{r, eval=FALSE}
dim(bpa_bioactivity)
names(bpa_bioactivity)
```

In reviewing the  number of dose response data associated with Bisphenol A, `aeid` value 2037 appears to be the most represented endpoint. To learn more about this endpoint, we retrieve the associated assay annotation information.

```{r, eval=FALSE, include=FALSE}
sort(bpa_bioactivity[, unique(aeid)])

bpa_bioactivity[, .(Number = .N), by = .(aeid)][order(-Number, aeid),]
```


```{r}
assay_2037 <- get_annotation_by_aeid(AEID = 2037, Server = 'https://api-ccte-stg.epa.gov/bioactivity')
assay_2037 <- data.table::as.data.table(assay_2037)

head(assay_2037)
```

### Review Bioactivity Data for Chemical Lists

Then, if curious about other chemicals tested for this same endpoint:

```{r}
assay_2037_data <- get_bioactivity_details(AEID = 2037, Server = stg_bioactivity_server)
assay_2037_data <- data.table::as.data.table(assay_2037_data)

head(assay_2037_data)
```

Let us now look at which chemicals from each data set have assay data associated to `aeid` value 2037.

```{r}
ccl4_2037 <- intersect(ccl4$dtxsid, assay_2037_data$dtxsid)
natadb_2037 <- intersect(natadb$dtxsid, assay_2037_data$dtxsid)

ccl4_2037
natadb_2037
```
We do the following search to determine the assay results for chemicals in each of CCL4 and NATADB that have assay `aeid` value 2037.

```{r}
ccl4_2037 <- assay_2037_data[dtxsid %in% ccl4_2037, ][order(dtxsid), ]
natadb_2037 <- assay_2037_data[dtxsid %in% natadb_2037, ][order(dtxsid), ]
```

We calculate the mean `ac50` value for the associated data and grouped by chemical.

```{r}
ccl4_2037[!is.na(ac50), .(Mean_AC50 = mean(ac50))]
ccl4_2037[!is.na(ac50), .(Mean_AC50 = mean(ac50)), by = .(dtxsid)][order(-Mean_AC50),]

natadb_2037[!is.na(ac50), .(Mean_AC50 = mean(ac50))]
natadb_2037[!is.na(ac50), .(Mean_AC50 = mean(ac50)), by = .(dtxsid)][order(-Mean_AC50),]
```

From this we observe that the average `ac50` values of the chemicals in CCL4 that have assay data for `aeid` 2037 is 20.38932 while for NATADB it is 37.8065. The maximum `ac50` values for CCL4 chemicals is 50, shared by the four chemicals identified by DTXSID0021464, DTXSID4022361, DTXSID9032113, and DTXSID5020576 while for NATADB the max value if 90.59979 given by the chemical identified by DTXSID9020299. For CCL4, the minimum `ac50` value for this set of chemicals is 0.4138751 given by the chemical identified by DTXSID8031865 and for NATADB is 4.67915 given by the chemical identified by DTXSID4021395.

We look at the same assay result for BPA to compared the values we just calculated.

```{r}
bpa_bioactivity[aeid %in% 2037, .(Mean_AC50 = mean(ac50))]
```

From this, we see that the average `ac50` value for `aeid` value 2037 Assay data for CCL4 chemicals is distributed above and below that of BPA in equal quantity, while for NATADB chemicals, all but two of 13 are higher. 


## Conclusion

In this vignette, a variety of functions that access different types of data found in the `Bioactivity` endpoints of the CCTE APIs were explored. While this exploration was not exhaustive, it provides a basic introduction to how one may access data and work with it. Additional endpoints and corresponding functions exist and we encourage the user to explore these while keeping in mind the examples contained in this vignette.

```{r breakdown, echo = FALSE, results = 'hide'}
# This chunk will be hidden in the final product. It serves to undo defining the
# custom print function to prevent unexpected behavior after this module during
# the final knitting process

knit_print.data.table = knitr::normal_print
  
registerS3method(
  "knit_print", "data.table", knit_print.data.table,
  envir = asNamespace("knitr")
)
```

```{r, include=FALSE}
end_vignette()
```
