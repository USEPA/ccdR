---
title: "Getting started with ccdR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{quickstart}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, include=FALSE}
library(httptest)
httptest::start_vignette('quickstart')
```


```{r setup}
devtools::load_all()
#library(ccdR)
```

# ccdR quickstart guide

The [CompTox Chemicals Dashboard](https://comptox.epa.gov/dashboard/) (CCD) provides a centralized location for data on chemicals. Such data includes phys-chem properties, hazard details, and bioactivity, among others. For users interested in looking up a few chemicals and using the associated data, the website provides a great resource. Moreover, for those interested in batch searching a list of chemicals, the CCD also supplies this functionality, offering a variety of output formats from which one can choose.

However, the batch search functionality of the CCD does not necessarily fit well into a programmatic approach to handling chemical data. For this, accessing the information available on the CCD through an API is a better solution. And recently, such an API became publicly available; the [CCTE APIs](https://api-ccte.epa.gov/docs/index.html) provide access to this information.

Users who are not familiar or experienced with using APIs may not find it appealing learning and writing code to access the APIs, so ccdR provides a more friendly alternative to this. 

## API key

Before getting started, a user must have an API key ready to use in order to access the CCTE APIs. This can be obtained from the admins of the CCTE APIs. In this vignette, the key will be stored as `my_key`.

## Chemical APIs

The CCTE APIs are split into three sections, the first of which is [Chemical APIs](https://api-ccte.epa.gov/docs/chemical.html#/). In the next several code chunks, we demonstrate how to use functions from ccdR to access different types of chemical information.

The first function we explore is `get_chemical_details()`, which takes in either the DTXSID or DTXCID of a chemical and the user-specific API key. We obtain the relevant chemical details for Bisphenol A, which has DTXSID "DTXSID7020182".

```{r}
bisphenol_a <- get_chemical_details(DTXSID = 'DTXSID7020182',
                                    API_key = my_key)
bisphenol_a
```
The output of this function is a data.table. We could have also input the DTXCID rather than the DTXSID and returned the same data.

The function `get_chem_info()` is similar. This returns phys-chem properties, which can be filtered to 'experimental' or 'predicted' if desired.

```{r}
bpa_info <- get_chem_info(DTXSID = "DTXSID7020182",
                          API_key = my_key)
bpa_info_experimental <- get_chem_info(DTXSID = "DTXSID7020182",
                                       type = 'experimental',
                                       API_key = my_key)
bpa_info_predicted <- get_chem_info(DTXSID = "DTXSID7020182",
                                    type = 'predicted',
                                    API_key = my_key)
bpa_info
bpa_info_experimental
bpa_info_predicted
```

To gather chemical fate details, we supply the same information as we did for *bpa_info* to the function `get_fate_by_dtxsid()`.

The next set of functions operate by searching for chemicals that match an input character string; those that start with, those that contain, and those that equal the input string. Each takes in a string and the API key and each returns a data.frame with 11 columns, giving various details of the matched chemicals.

We demonstrate this on the function `chemical_equal()`, though the behavior of the functions `chemical_contains()` and `chemical_starts_with()` are analogous.

```{r}
bpa_equals <- chemical_equal(word = 'Bisphenol a',
                             API_key = my_key)
bpa_equals
```
Next we demonstrate the family of ms ready functions. These return lists of DTXSIDs of chemicals that match the search criteria. For the example, we use Methane, with chemical formula CH4, mono-isotopic mass of 16.0313g, and DTXCID of DTXSID8025545.

```{r}
methane_formula <- get_msready_by_formula(formula = 'CH4', 
                                          API_key = my_key)
length(methane_formula)
methane_mass <- get_msready_by_mass(start = 16.0313,
                                    end = 16.0314,
                                    API_key = my_key)
length(methane_mass)
methane_dtxsid <- get_msready_by_dtxcid(DTXCID = 'DTXCID705545',
                                        API_key = my_key)
length(methane_dtxsid)
print(identical(methane_dtxsid, methane_formula))
print(identical(methane_dtxsid, methane_mass))
```
Observe that the lists of chemical DTXSIDs returned from the three functions are identical. One should note that when using the function `get_msready_by_mass`, the start and end range are sensitive to very small changes, so extra attention needs to be given to the input of this function.

The next set of functions allow the user to access publicly available lists of chemicals. We first display the list of chemical lists and the search by the type of chemical lists available.

```{r}
public_lists <- get_all_public_chemical_lists(API_key = my_key)
public_lists
federal_public_lists <- get_chemical_lists_by_type(type = 'federal',
                                                   API_key = my_key)
federal_public_lists
```
We can then access information about a specific list, for instance 'BIOSOLIDS2021'.

```{r}
biosolids_2021_info <- get_public_chemical_list_by_name(list_name = 'BIOSOLIDS2021',
                                                        API_key = my_key)
biosolids_2021_info
biosolids_2021_chemicals <- get_chemicals_in_list(list_name = 'BIOSOLIDS2021',
                                                  API_key = my_key)
biosolids_2021_chemicals
```
Finally, is one is interested in finding all lists that contain a particular chemical, one may do so by using the DTXSID of the chemical in question.

```{r}
bpa_lists <- get_lists_containing_chemical(DTXSID = 'DTXSID7020182',
                                           API_key = my_key)
bpa_lists
```
Additional formats of chemical data are also available for interested users. These include Marvin files (.mrv), mol files (.mol), and image files.

We demonstrate this below.

```{r}
bpa_mrv <- get_chemical_mrv(DTXSID = 'DTXSID7020182',
                            API_key = my_key)
if (requireNamespace("XML", quietly = TRUE)){
  XML::xmlTreeParse(bpa_mrv)
}


bpa_mol <- get_chemical_mol(DTXSID = 'DTXSID7020182',
                            API_key = my_key)
cat(bpa_mol)

bpa_image_matrix <- get_chemical_image(DTXSID = 'DTXSID7020182',
                                       API_key = my_key)
if (requireNamespace("countcolors", quietly = TRUE)){
  countcolors::plotArrayAsImage(bpa_image_matrix)
}
```

## Hazard APIs

Next, we explore the hazard APIs. This set of APIs allows the user to access human or ecological toxicity data for a given chemical. One can specify the chemical in question through the DTXSID.

```{r}
bpa_hazard <- get_hazard_by_dtxsid(DTXSID = 'DTXSID7020182',
                                   API_key = my_key)
bpa_hazard
bpa_human_hazard <- get_human_hazard_by_dtxsid(DTXSID = 'DTXSID7020182',
                                               API_key = my_key)
bpa_human_hazard
bpa_eco_hazard <- get_ecotox_hazard_by_dtxsid(DTXSID = 'DTXSID7020182',
                                              API_key = my_key)
bpa_eco_hazard
```


## Bioactivity APIs

The last set of APIs allow the user to access bioactivity information for a given chemical DTXSID or AEID.

```{r}
bpa_bioactivity <- get_bioactivity_details(DTXSID = 'DTXSID7020182',
                                           API_key = my_key)
bpa_bioactivity
```



```{r, include=FALSE}
httptest::end_vignette()
```

