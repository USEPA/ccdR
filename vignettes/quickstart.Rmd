---
title: "Getting started with ccdR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{"Getting started with ccdR"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = (nchar(Sys.getenv('CCTE_API_KEY')) > 0)
)
library(httptest)
start_vignette("1")
```


```{r setup}
if (!library(ccdR, logical.return = TRUE)){
  devtools::load_all()
}
```

```{r setup-print, echo = FALSE}
# Redefining the knit_print method to truncate character values to 25 characters
# in each column and to truncate the columns in the print call to prevent 
# wrapping tables with several columns.
#library(ccdR)
knit_print.data.table = function(x, ...) {
  y <- data.table::copy(x)
  y <- y[, lapply(.SD, function(t){
    if (is.character(t)){
      t <- strtrim(t, 25)
    }
    return(t)
  })]
  print(y, trunc.cols = TRUE)
}

registerS3method(
  "knit_print", "data.table", knit_print.data.table,
  envir = asNamespace("knitr")
)
```


# ccdR quickstart guide

The [CompTox Chemicals Dashboard](https://comptox.epa.gov/dashboard/) (CCD) provides a centralized location for data on chemicals. Such data includes phys-chem properties, hazard details, and bioactivity, among others. For users interested in looking up a few chemicals and using the associated data, the website provides a great resource. Moreover, for those interested in batch searching a list of chemicals, the CCD also supplies this functionality, offering a variety of output formats from which one can choose.

However, the batch search functionality of the CCD does not necessarily fit well into a programmatic approach to handling chemical data. For this, accessing the information available on the CCD through an API is a better solution. And recently, such an API became publicly available; the [CCTE APIs](https://api-ccte.epa.gov/docs/index.html) provide access to this information.

Users who are not familiar or experienced with using APIs may not find it appealing learning and writing code to access the APIs, so ccdR provides a more friendly alternative to this. 


## API key

Before getting started, a user must have an API key ready to use in order to access the CCTE APIs. This can be obtained from the admins of the CCTE APIs by emailing [CCTE API Admins](mailto:ccte_api@epa.gov). In this vignette, the key will be stored as the variable `my_key`. We will also demonstrate how to store the key in a single session or across sessions and how to access the key.

First, we store the api key in the variable `my_key`.

```{r, echo = FALSE}
my_key <- ccte_key()
```



```{r, eval = FALSE, api-key}
my_key <- 'YOUR_CCTE_API_key'
```

For general use of the package, one may use the function `register_ccdr()` to store the API key in the current session or more permanently for access across sessions. The following example demonstrates this.

```{r, register-ccte, eval=FALSE}
# This stores the key in the current session
register_ccdr(key = '<YOUR API KEY>')

# This stores the key across multiple sessions and only needs to be run once. If the key changes, rerun this with the new key.
register_ccdr(key = '<YOUR API KEY>', write = TRUE)
```

The API key is stored and the default display setting is turned off for protection. To change this, use the following functions as demonstrated.

```{r, display-hide-key}
# To show the API key
ccdr_show_api_key()
getOption('ccdr')$display_api_key

# To hide the API key
ccdr_hide_api_key()
getOption('ccdr')$display_api_key
```

Finally, to access the key, use the `ccte_key()` function.

```{r, ccte-key, eval = FALSE}
ccte_key()
```



## Chemical APIs

The CCTE APIs are split into three sections, the first of which is [Chemical APIs](https://api-ccte.epa.gov/docs/chemical.html#/). In the next few code chunks, we demonstrate how to use functions from ccdR to access different types of chemical information.

### Chemical Details Resource

The first function we explore is `get_chemical_details()`, which takes in either the DTXSID or DTXCID of a chemical and the user-specific API key. We obtain the relevant chemical details for Bisphenol A (BPA), which has DTXSID "DTXSID7020182".

```{r, bpa-chem-details}
bpa_details <- get_chemical_details(DTXSID = 'DTXSID7020182',
                                    API_key = my_key)
bpa_details <- data.table::as.data.table(bpa_details)
head(bpa_details)
```
The output of this function is a data.table. We could have also input the DTXCID rather than the DTXSID and returned the same data.

### Chemical Property Resource

The function `get_chem_info()` is similar. This returns phys-chem properties, which can be filtered to 'experimental' or 'predicted' if desired.


First, we grab all results. 

```{r, bpa-chem-info}
bpa_info <- get_chem_info(DTXSID = "DTXSID7020182",
                          API_key = my_key)
bpa_info <- data.table::as.data.table(bpa_info)

head(bpa_info)
```

Next, we filter by experimental results.

```{r, bpa-experimental}
bpa_info_experimental <- get_chem_info(DTXSID = "DTXSID7020182",
                                       type = 'experimental',
                                       API_key = my_key)
bpa_info_experimental <- data.table::as.data.table(bpa_info_experimental)

head(bpa_info_experimental)
```

For a more comprehensive treatment of the chemical endpoints, please see the 'Chemical' vignette that explores more of the ccdR functions related to the associated chemical endpoints.

## Hazard APIs

Next, we explore the hazard APIs. We first demonstrate how to access human or ecological toxicity data for a given chemical. One can specify the chemical in question through the DTXSID.

### Hazard Resource

We first grab all such hazard data.

```{r, hazard}
bpa_hazard <- get_hazard_by_dtxsid(DTXSID = 'DTXSID7020182',
                                   API_key = my_key)
bpa_hazard <- data.table::as.data.table(bpa_hazard)
head(bpa_hazard)
```

Then we focus on human hazard data.

```{r, human-hazard}
bpa_human_hazard <- get_human_hazard_by_dtxsid(DTXSID = 'DTXSID7020182',
                                               API_key = my_key)
bpa_human_hazard <- data.table::as.data.table(bpa_human_hazard)
head(bpa_human_hazard)
```

And finally we focus on ecotox hazard data.

```{r, ecotox-hazard}
bpa_eco_hazard <- get_ecotox_hazard_by_dtxsid(DTXSID = 'DTXSID7020182',
                                              API_key = my_key)
bpa_eco_hazard <- data.table::as.data.table(bpa_eco_hazard)
head(bpa_eco_hazard)
```

For more examples, please refer to the 'Hazard' vignette.

## Bioactivity APIs

The last set of APIs allow the user to access bioactivity information for a given chemical DTXSID or AEID.

### Bioactivity Resource

We first demonstrate obtaining bioactivity data based on an input DTXSID.

```{r, bioactivity-dtxsid}
bpa_bioactivity <- get_bioactivity_details(DTXSID = 'DTXSID7020182',
                                           API_key = my_key)

bpa_bioactivity <- data.table::as.data.table(bpa_bioactivity)
head(bpa_bioactivity)
```

If instead we want to search by assay id, we can do so using the same function.

```{r, bioactivity-aeid}
assay_id_search <- get_bioactivity_details(AEID = 42,
                                           API_key = my_key)
assay_id_search <- data.table::as.data.table(assay_id_search)
head(assay_id_search)
```

Again, for more information please refer to the 'Bioactivity' vignette.

## Conclusion

The ccdR package provides a streamlined approach to accessing data from the CCD for users with little or no prior experience using APIs. The functionality can be used within a variety of workflows that require data found on the CCD. To explore more examples of the various endpoints and functionality provided by the ccdR package, please refer to the 'Chemical', 'Hazard', or 'Bioactivity' vignettes.

```{r breakdown, echo = FALSE, results = 'hide'}
# This chunk will be hidden in the final product. It serves to undo defining the
# custom print function to prevent unexpected behavior after this module during
# the final knitting process

knit_print.data.table = knitr::normal_print
  
registerS3method(
  "knit_print", "data.table", knit_print.data.table,
  envir = asNamespace("knitr")
)
```

```{r, include=FALSE}
end_vignette()
```
